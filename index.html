<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Go WebSocket Tutorial</title>
  </head>
  <body>
    <h2>Hello World</h2>
    <div style="width: 500px;">
        <canvas id="myChart"></canvas>
    </div>

    <script type="text/javascript" src="moment.js"></script>
    <script type="text/javascript" src="Chart.js"></script>
    <script type="text/javascript" src="chartjs-plugin-streaming.js"></script>

    <script>
        let cpuData = [];
        let runOneTime = 1;
    </script>

    <script>
        function initChart(cpuCount) {
            var ctx = document.getElementById('myChart').getContext('2d');
            let datasets = [];
            for (let index = 1; index <= cpuCount; index++) {
                datasets.push({
                    data: [],
                    label: "cpu " + index
                });
            }

            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },

                options: {
                    scales: {
                        xAxes: [{
                            type: 'time',
                            realtime: {
                                delay: 2000,
                                onRefresh: function(chart) {
                                    let datasetIndex = 0;
                                    chart.data.datasets.forEach(function(dataset) {
                                        dataset.data.push(...cpuData[datasetIndex]);
                                        cpuData[datasetIndex] = [];
                                        datasetIndex ++;
                                    });
                                }
                            }
                        }]
                    }
                }
            });
        }
    </script>

    <script>
        let socket = new WebSocket("ws://127.0.0.1:1234/ws");
        console.log("Attempting Connection...");

        socket.onopen = () => {
            console.log("Successfully Connected");
            socket.send("Hi From the Client!")
        };
        
        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
            socket.send("Client Closed!")
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        socket.onmessage = event => {
            let cpuJsonData = JSON.parse(event.data)
            let cpuCount = cpuJsonData.length;
            if (runOneTime) {
                initChart(cpuCount)
                runOneTime = 0;
            }
            for (let index = 0; index < cpuJsonData.length; index++) {
                if(typeof cpuData[index] === 'undefined') {
                    cpuData[index] = []
                }
                cpuData[index].push({
                    x: Date.now(),
                    y: cpuJsonData[index]
                })
            }
        };
    </script>
  </body>
</html>